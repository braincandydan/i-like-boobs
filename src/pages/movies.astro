---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import MovieCard from '../components/MovieCard.astro';
import MoviesPageSections from '../components/MoviesPageSections';
import { fetchFromTMDB, tmdbEndpoints } from '../lib/tmdb';

// Fetch movie data for server-rendered fallback
const [popularData, topRatedData, upcomingData] = await Promise.all([
  fetchFromTMDB(tmdbEndpoints.popularMovies).catch(() => ({ results: [] })),
  fetchFromTMDB(tmdbEndpoints.topRatedMovies).catch(() => ({ results: [] })),
  fetchFromTMDB(tmdbEndpoints.upcomingMovies).catch(() => ({ results: [] })),
]);

const sections = [
  {
    id: 'popular-movies',
    title: 'Popular Movies',
    movies: popularData.results?.slice(0, 12) || [],
  },
  {
    id: 'top-rated',
    title: 'Top Rated Movies',
    movies: topRatedData.results?.slice(0, 12) || [],
  },
  {
    id: 'upcoming',
    title: 'Upcoming Movies',
    movies: upcomingData.results?.slice(0, 12) || [],
  }
].filter(section => section.movies.length > 0);
---

<Layout title="Movies - NotFlix">
  <Navbar />
  
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl font-bold text-white mb-12">Movies</h1>
    
    <!-- Server-rendered Content Sections (fallback - shows initially) -->
    <div id="server-rendered-sections" class="space-y-12">
      {sections.map((section) => (
        <section>
          <h2 class="text-2xl font-bold text-white mb-6">
            {section.title}
          </h2>
          <div class="content-grid">
            {section.movies.map((movie) => (
              <MovieCard movie={movie} mediaType="movie" />
            ))}
          </div>
        </section>
      ))}
    </div>
    
    <!-- Dynamic Sections (loads from database - respects admin order and visibility) -->
    <MoviesPageSections client:load />
  </main>
</Layout>
